<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hybrid Rules Engine: Workflow & Cross-Module Support Analysis</title>
    <style>
        body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
  max-width: 1400px;
   margin: 0 auto;
            padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            color: #333;
     }
        .container {
            background: white;
    padding: 40px;
         border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
      h1 {
     color: #667eea;
            border-bottom: 4px solid #764ba2;
        padding-bottom: 15px;
            font-size: 2.8em;
 text-align: center;
  }
        h2 {
            color: #764ba2;
            margin-top: 35px;
            font-size: 2em;
            border-left: 6px solid #f093fb;
            padding-left: 15px;
        }
        h3 {
            color: #667eea;
         margin-top: 25px;
            font-size: 1.4em;
        }
        .supported-box {
    background: #d1fae5;
            border-left: 5px solid #10b981;
            padding: 25px;
      margin: 20px 0;
          border-radius: 8px;
        }
        .enhancement-needed {
            background: #fef3c7;
            border-left: 5px solid #f59e0b;
         padding: 25px;
    margin: 20px 0;
  border-radius: 8px;
        }
   .recommendation-box {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
         margin: 30px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
     pre {
            background: #1e293b;
         color: #e2e8f0;
      padding: 20px;
          border-radius: 8px;
      overflow-x: auto;
            border-left: 4px solid #764ba2;
        }
  table {
    width: 100%;
       border-collapse: collapse;
            margin: 20px 0;
       box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        th, td {
      padding: 14px;
  text-align: left;
     border-bottom: 1px solid #e5e7eb;
        }
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
         font-weight: 600;
        }
    tr:hover {
    background: #f3f4f6;
        }
        .badge {
            display: inline-block;
 padding: 6px 14px;
            border-radius: 15px;
        font-size: 0.85em;
     font-weight: bold;
      margin-right: 8px;
        }
        .badge-yes { background: #10b981; color: white; }
        .badge-partial { background: #f59e0b; color: white; }
      .badge-needs { background: #ef4444; color: white; }
        ul {
margin: 10px 0;
        padding-left: 30px;
        }
    li {
  margin: 10px 0;
      }
        code {
    background: #f3f4f6;
            padding: 3px 8px;
            border-radius: 4px;
   font-family: 'Courier New', monospace;
          font-size: 0.9em;
     color: #764ba2;
        }
  </style>
</head>
<body>
 <div class="container">
        <h1>?? Hybrid Rules Engine Analysis</h1>
        <p style="text-align: center; font-size: 1.3em; color: #6b7280; font-style: italic;">
            Workflow Branching & Cross-Module Field Visibility Support
     </p>

        <h2>?? Your Requirements</h2>

  <table>
    <thead>
        <tr>
<th>Requirement</th>
     <th>Description</th>
       <th>Current Support</th>
          </tr>
            </thead>
       <tbody>
             <tr>
            <td><strong>1. Workflow Branching Logic</strong></td>
       <td>Skip steps, conditional navigation between modules</td>
      <td><span class="badge badge-partial">PARTIAL</span></td>
           </tr>
         <tr>
 <td><strong>2. Cross-Module Field Visibility</strong></td>
            <td>Field in Module B depends on field value in Module A</td>
      <td><span class="badge badge-needs">NEEDS ENHANCEMENT</span></td>
 </tr>
            </tbody>
  </table>

        <h2>? Current Hybrid Rules Support</h2>

        <div class="supported-box">
            <h3 style="color: #10b981; margin-top: 0;">What's Already Supported</h3>
            
<h4>1. Single-Module Conditional Logic ?</h4>
        <p>The hybrid approach already supports:</p>
<ul>
      <li><strong>Field Visibility</strong> - Show/hide fields based on other field values in same module</li>
            <li><strong>Field Read-Only State</strong> - Enable/disable fields conditionally</li>
          <li><strong>Required Field Rules</strong> - Make fields required based on conditions</li>
            <li><strong>Complex AND/OR Logic</strong> - Nested conditions with multiple operators</li>
            </ul>

  <pre>// Example: Show business number field if org type is "Business"
var rule = new ConditionalRule
{
    Id = "show_business_number",
    Target = "field_business_number",
    Action = "show",
    Condition = new Condition
    {
        Field = "field_org_type",
Operator = "eq",
        Value = "Business"
    }
};</pre>
        </div>

        <h2>?? Enhancements Needed</h2>

        <div class="enhancement-needed">
          <h3 style="color: #f59e0b; margin-top: 0;">Enhancement 1: Workflow Branching (Step Navigation)</h3>
            
   <h4>What's Missing:</h4>
            <ul>
         <li><strong>SkipStep Action</strong> - Conditional module/step skipping not defined</li>
     <li><strong>Workflow-Level Rules</strong> - Rules currently assume single module context</li>
       <li><strong>Dynamic Navigation</strong> - Can't change next/previous module based on conditions</li>
            </ul>

   <h4>Proposed Enhancement:</h4>
         <pre>// Enhancement 1: Add workflow-level actions
public enum RuleAction
{
    Show,           // Show/hide field
    Hide,
    Enable,         // Enable/disable field
  Disable,
    SetRequired,    // Make field required
    
    // ?? NEW WORKFLOW ACTIONS
    SkipStep,       // Skip entire module/step
    GoToStep,     // Jump to specific step
    CompleteWorkflow // Mark workflow as complete
}

// Enhancement 2: Add step targeting
public record ConditionalRule
{
 public required string Id { get; init; }
    
    // Can target EITHER a field OR a step
    public string? TargetFieldId { get; init; }
    public int? TargetStepNumber { get; init; }
    
    public required string Action { get; init; }
    public required Condition Condition { get; init; }
}

// Usage: Skip financial review if amount < $10,000
var workflowRule = new ConditionalRule
{
    Id = "skip_financial_review",
    TargetStepNumber = 3,  // Module 3 = Financial Review
    Action = "skipStep",
    Condition = new Condition
    {
        Field = "Step1.total_amount",  // Cross-module reference!
     Operator = "lt",
 Value = 10000
    }
};</pre>
        </div>

        <div class="enhancement-needed">
   <h3 style="color: #f59e0b; margin-top: 0;">Enhancement 2: Cross-Module Field References</h3>
            
          <h4>What's Missing:</h4>
    <ul>
 <li><strong>Module Scope</strong> - Field references currently assume same module</li>
        <li><strong>Workflow Data Context</strong> - No mechanism to pass data across modules</li>
      <li><strong>Reference Syntax</strong> - Need dot notation: <code>ModuleId.FieldId</code></li>
            </ul>

        <h4>Proposed Enhancement:</h4>
       <pre>// Enhancement: Support cross-module field references

// Option 1: Numeric Module ID
{
  "field": "1.applicant_age",  // Module 1, field "applicant_age"
  "op": "lt",
  "value": 18
}

// Option 2: Named Module References (better!)
{
  "field": "PersonalInfo.applicant_age",  // Module named "PersonalInfo"
  "op": "lt",
  "value": 18
}

// C# Implementation:
public record Condition
{
    // Simple field reference: "age"
    // Cross-module reference: "Module1.age" or "PersonalInfo.age"
    public string? Field { get; init; }
    
    public string? Operator { get; init; }
    public object? Value { get; init; }
    
    // Complex conditions
    public LogicalOperator? LogicalOp { get; init; }
    public Condition[]? Conditions { get; init; }
}

// Evaluator enhancement:
public bool Evaluate(Condition condition, WorkflowFormData workflowData)
{
    if (condition.Field != null)
    {
        // Parse field reference
        var (moduleKey, fieldId) = ParseFieldReference(condition.Field);
    
      // Get value from correct module context
      var fieldValue = GetFieldValue(workflowData, moduleKey, fieldId);
        
  return EvaluateOperator(fieldValue, condition.Operator, condition.Value);
}
    // ... rest of evaluation logic
}

private (string? moduleKey, string fieldId) ParseFieldReference(string fieldRef)
{
    if (fieldRef.Contains('.'))
    {
        var parts = fieldRef.Split('.', 2);
    return (parts[0], parts[1]);
    }
    return (null, fieldRef);  // No module prefix = current module
}</pre>
        </div>

        <h2>?? Enhanced Schema for V4</h2>

        <h3>Enhanced ConditionalRule</h3>
   <pre>namespace DynamicForms.Core.V4.Schemas;

/// <summary>
/// Enhanced conditional rule supporting workflow branching and cross-module references
/// </summary>
public record ConditionalRule
{
    /// <summary>
    /// Unique rule identifier
    /// </summary>
    public required string Id { get; init; }
    
    /// <summary>
    /// Rule description (for documentation/debugging)
    /// </summary>
    public string? Description { get; init; }
  
  /// <summary>
  /// Target field ID (for field-level actions: show, hide, enable, disable, setRequired)
    /// </summary>
    public string? TargetFieldId { get; init; }
    
    /// <summary>
    /// Target step number (for workflow-level actions: skipStep, goToStep)
  /// </summary>
    public int? TargetStepNumber { get; init; }
    
    /// <summary>
    /// Target module ID or name (for module-level actions)
    /// </summary>
    public string? TargetModuleKey { get; init; }
    
    /// <summary>
    /// Action to perform when condition is met
    /// Values: show, hide, enable, disable, setRequired, skipStep, goToStep, completeWorkflow
    /// </summary>
  public required string Action { get; init; }
    
    /// <summary>
    /// Condition that determines whether action is triggered
    /// </summary>
    public required Condition Condition { get; init; }
    
    /// <summary>
    /// Priority for rule execution order (lower = higher priority)
    /// </summary>
    public int Priority { get; init; } = 100;
}

/// <summary>
/// Enhanced condition supporting cross-module field references
/// </summary>
public record Condition
{
    // Simple condition (leaf node)
    
    /// <summary>
    /// Field reference (supports cross-module: "ModuleKey.FieldId" or "FieldId")
    /// Examples: "age", "Step1.age", "PersonalInfo.age"
    /// </summary>
    public string? Field { get; init; }
    
    /// <summary>
    /// Comparison operator
    /// Values: eq, neq, lt, lte, gt, gte, in, notIn, contains, startsWith, endsWith, isEmpty, isNotEmpty
    /// </summary>
    public string? Operator { get; init; }
  
    /// <summary>
    /// Expected value to compare against
    /// </summary>
    public object? Value { get; init; }
    
    // Complex condition (branch node)
    
    /// <summary>
    /// Logical operator for combining sub-conditions
    /// </summary>
    public LogicalOperator? LogicalOp { get; init; }
  
    /// <summary>
    /// Array of sub-conditions
    /// </summary>
    public Condition[]? Conditions { get; init; }
}

public enum LogicalOperator
{
    And,
    Or,
    Not
}

/// <summary>
/// Workflow form data container for multi-module evaluation
/// </summary>
public class WorkflowFormData
{
    /// <summary>
  /// Dictionary of module data: ModuleKey => FieldData
    /// ModuleKey can be module ID (e.g., "1") or module name (e.g., "PersonalInfo")
    /// </summary>
    public Dictionary<string, Dictionary<string, object?>> Modules { get; set; } = new();
    
    /// <summary>
    /// Current active module key
    /// </summary>
    public string? CurrentModuleKey { get; set; }
    
    /// <summary>
    /// Get field value with optional module scoping
    /// </summary>
    public object? GetFieldValue(string? moduleKey, string fieldId)
    {
        // If no module specified, use current module
        var targetModule = moduleKey ?? CurrentModuleKey;
   
        if (targetModule != null && Modules.TryGetValue(targetModule, out var moduleData))
  {
            return moduleData.GetValueOrDefault(fieldId);
        }
        
   return null;
    }
}</pre>

        <h2>?? Feature Comparison</h2>

        <table>
  <thead>
      <tr>
        <th>Feature</th>
               <th>Current Hybrid</th>
     <th>Enhanced V4</th>
</tr>
            </thead>
        <tbody>
           <tr>
              <td><strong>Single-Module Rules</strong></td>
    <td><span class="badge badge-yes">?</span> Full support</td>
      <td><span class="badge badge-yes">?</span> Full support</td>
      </tr>
        <tr>
            <td><strong>AND/OR/NOT Logic</strong></td>
      <td><span class="badge badge-yes">?</span> Supported</td>
   <td><span class="badge badge-yes">?</span> Supported</td>
                </tr>
<tr>
     <td><strong>Field Actions (show/hide/enable/disable)</strong></td>
       <td><span class="badge badge-yes">?</span> Supported</td>
     <td><span class="badge badge-yes">?</span> Supported</td>
            </tr>
 <tr>
         <td><strong>Workflow Branching (skipStep)</strong></td>
            <td><span class="badge badge-needs">?</span> Not supported</td>
     <td><span class="badge badge-yes">?</span> Full support</td>
           </tr>
  <tr>
          <td><strong>Cross-Module Field References</strong></td>
    <td><span class="badge badge-needs">?</span> Not supported</td>
                <td><span class="badge badge-yes">?</span> Full support</td>
            </tr>
 <tr>
        <td><strong>Dynamic Step Navigation</strong></td>
            <td><span class="badge badge-needs">?</span> Not supported</td>
<td><span class="badge badge-yes">?</span> Full support</td>
             </tr>
       <tr>
             <td><strong>Rule Priority/Ordering</strong></td>
                    <td><span class="badge badge-partial">~</span> Implicit</td>
         <td><span class="badge badge-yes">?</span> Explicit priority</td>
     </tr>
 </tbody>
        </table>

        <h2>?? Implementation Examples</h2>

        <h3>Example 1: Workflow Branching</h3>
        <pre>// Skip financial review step if amount < $10,000
var rule = new ConditionalRule
{
    Id = "skip_financial_review",
    Description = "Skip financial review for small amounts",
    TargetStepNumber = 3,  // Financial Review is step 3
    Action = "skipStep",
    Condition = new Condition
  {
        Field = "Step1.total_amount",  // Cross-module reference!
        Operator = "lt",
   Value = 10000
    }
};

// Serializes to clean JSON:
{
  "id": "skip_financial_review",
  "description": "Skip financial review for small amounts",
  "targetStepNumber": 3,
  "action": "skipStep",
  "condition": {
    "field": "Step1.total_amount",
    "operator": "lt",
    "value": 10000
  }
}</pre>

     <h3>Example 2: Cross-Module Field Visibility</h3>
        <pre>// Show parental consent in Module 2 if age < 18 in Module 1
var rule = new ConditionalRule
{
    Id = "show_parental_consent",
 Description = "Require parental consent for minors",
    TargetFieldId = "sec_parental_consent",  // Field in Module 2
    Action = "show",
    Condition = new Condition
    {
        LogicalOp = LogicalOperator.And,
        Conditions = new[]
  {
        new Condition 
            { 
   Field = "PersonalInfo.applicant_age",  // Module 1 field
    Operator = "lt",
      Value = 18
         },
    new Condition
   {
       LogicalOp = LogicalOperator.Or,
         Conditions = new[]
                {
     new Condition { Field = "PersonalInfo.province", Operator = "eq", Value = "ON" },
       new Condition { Field = "PersonalInfo.province", Operator = "eq", Value = "QC" }
   }
            }
    }
    }
};</pre>

      <h3>Example 3: Complex Workflow Logic</h3>
        <pre>// Go directly to completion if user is pre-approved
var rule = new ConditionalRule
{
    Id = "skip_to_completion_if_preapproved",
    Description = "Skip detailed application for pre-approved applicants",
    TargetStepNumber = 5,  // Jump to step 5 (completion)
    Action = "goToStep",
    Condition = new Condition
    {
        LogicalOp = LogicalOperator.And,
        Conditions = new[]
        {
            new Condition { Field = "Step1.approval_status", Operator = "eq", Value = "pre_approved" },
            new Condition { Field = "Step1.credit_score", Operator = "gte", Value = 750 }
        }
    }
};</pre>

        <div class="recommendation-box">
   <h2 style="color: white; margin-top: 0;">?? CONFIRMATION & RECOMMENDATION</h2>
            
 <h3 style="color: white;">? YES - Both Requirements Can Be Supported!</h3>
            
     <div style="font-size: 1.1em; margin: 20px 0;">
<p><strong>Requirement 1: Workflow Branching Logic</strong></p>
          <ul>
        <li>? <strong>Can be supported</strong> by adding <code>skipStep</code> and <code>goToStep</code> actions</li>
     <li>? Rules can target <code>TargetStepNumber</code> or <code>TargetModuleKey</code></li>
 <li>? Condition evaluation remains identical (same hybrid approach)</li>
             </ul>

     <p><strong>Requirement 2: Cross-Module Field Visibility</strong></p>
    <ul>
     <li>? <strong>Can be supported</strong> by enhancing field reference syntax</li>
                <li>? Use dot notation: <code>ModuleKey.FieldId</code></li>
        <li>? Evaluator enhanced to accept <code>WorkflowFormData</code> with multi-module context</li>
      <li>? Works for ALL actions: show, hide, enable, disable, setRequired</li>
         </ul>
            </div>

            <h3 style="color: white; margin-top: 30px;">?? What Needs to Be Added to V4:</h3>
     <ol style="font-size: 1.1em;">
          <li><strong>Enhanced ConditionalRule schema</strong>
         <ul>
    <li>Add <code>TargetStepNumber</code> property</li>
        <li>Add <code>TargetModuleKey</code> property</li>
               <li>Expand <code>Action</code> enum: skipStep, goToStep, completeWorkflow</li>
      </ul>
        </li>
<li><strong>Cross-Module Field Reference Parsing</strong>
        <ul>
      <li>Update <code>Condition</code> evaluator to parse "ModuleKey.FieldId"</li>
          <li>Support numeric IDs: "1.age" or names: "PersonalInfo.age"</li>
          </ul>
                </li>
      <li><strong>WorkflowFormData Container</strong>
       <ul>
     <li>Create <code>WorkflowFormData</code> class to hold multi-module data</li>
  <li>Dictionary structure: <code>ModuleKey => FieldData</code></li>
   </ul>
      </li>
                <li><strong>Enhanced IConditionEvaluator</strong>
          <ul>
             <li>Add overload: <code>Evaluate(Condition, WorkflowFormData)</code></li>
      <li>Keep backward-compatible: <code>Evaluate(Condition, Dictionary&lt;string, object&gt;)</code></li>
      </ul>
                </li>
            <li><strong>Workflow Rules Collection</strong>
     <ul>
            <li>Add <code>WorkflowRules[]</code> to <code>FormWorkflowSchema</code></li>
    <li>Separate from module-level rules</li>
     </ul>
     </li>
       </ol>

    <h3 style="color: white; margin-top: 30px;">? Proceed with V4 Creation?</h3>
       <p style="font-size: 1.2em;">
 <strong>YES - The enhanced hybrid approach fully supports both requirements!</strong>
            </p>
      <ul style="font-size: 1.1em;">
     <li>? Maintains all benefits of hybrid approach (type-safe, IntelliSense, clean JSON)</li>
      <li>? Adds workflow branching (skipStep, goToStep)</li>
         <li>? Adds cross-module field references (ModuleKey.FieldId)</li>
      <li>? Works seamlessly with Blazor (same C# code server + WASM)</li>
             <li>? NOT over-engineered - natural extensions of existing design</li>
    <li>? Backward compatible - existing single-module rules still work</li>
            </ul>

     <h3 style="color: white; margin-top: 30px;">?? Ready to Proceed!</h3>
       <p style="font-size: 1.2em;">
Shall I copy V3 to V4 and implement these enhancements?
        </p>
        </div>

  <p style="text-align: center; margin-top: 60px; font-size: 1.2em; color: #999;">
        <strong>Analysis Complete</strong> | Claude Sonnet 4.5 | January 2025<br>
            <span style="font-size: 0.9em;">Hybrid Approach: ? Supports Workflow Branching + Cross-Module References</span>
        </p>
    </div>
</body>
</html>