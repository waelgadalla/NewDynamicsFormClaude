@using DynamicForms.Core.V2.Schemas

@*
    WorkflowModuleList - Displays ordered list of modules in a workflow with full details

    Features:
    - Shows module titles and IDs
    - Displays conditional branching information
    - Module selection
    - Reorder modules (move up/down)
    - Remove modules with confirmation
    - Add module dialog
*@

<div class="workflow-module-list">
    <!-- Header -->
    <div class="module-list-header">
        <h5 class="header-title">Workflow Modules</h5>
        <span class="module-count-badge">@GetModuleCount() modules</span>
    </div>

    <!-- Module List -->
    <div class="module-list-content">
        @if (Modules != null && Modules.Count > 0)
        {
            @for (int i = 0; i < Modules.Count; i++)
            {
                var index = i; // Capture for lambda
                var module = Modules[i];
                var isSelected = SelectedModuleId == module.ModuleId;
                var isFirst = i == 0;
                var isLast = i == Modules.Count - 1;

                <div class="@GetModuleItemClass(isSelected)">
                    <!-- Module Info -->
                    <div class="module-info" @onclick="() => HandleModuleClick(module.ModuleId)">
                        <div class="module-header">
                            <div class="module-number">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                                    <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"/>
                                </svg>
                                <span class="step-label">Step @(i + 1)</span>
                            </div>

                            @if (!module.IsRequired)
                            {
                                <span class="badge bg-secondary optional-badge">Optional</span>
                            }
                        </div>

                        <div class="module-title">
                            @(module.TitleEn ?? "Untitled Module")
                        </div>

                        <div class="module-id-display">
                            <code>Module #@module.ModuleId</code>
                        </div>

                        @if (module.Branch != null)
                        {
                            <div class="conditional-branch-info">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M11.5 2a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM9.05 3a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0V3h9.05zM4.5 7a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM2.05 8a2.5 2.5 0 0 1 4.9 0H16v1H6.95a2.5 2.5 0 0 1-4.9 0H0V8h2.05z"/>
                                </svg>
                                <span class="branch-text">
                                    If <code>@module.Branch.ConditionFieldId</code> @GetOperatorText(module.Branch.Operator) <code>@module.Branch.Value</code>
                                </span>
                            </div>
                        }
                    </div>

                    <!-- Action Buttons -->
                    <div class="module-actions">
                        <!-- Move Up -->
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary action-btn"
                                @onclick="() => HandleMoveUp(module.ModuleId, index)"
                                @onclick:stopPropagation="true"
                                disabled="@isFirst"
                                title="Move module up">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z"/>
                            </svg>
                        </button>

                        <!-- Move Down -->
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary action-btn"
                                @onclick="() => HandleMoveDown(module.ModuleId, index)"
                                @onclick:stopPropagation="true"
                                disabled="@isLast"
                                title="Move module down">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L7.5 13.293V1.5A.5.5 0 0 1 8 1z"/>
                            </svg>
                        </button>

                        <!-- Edit Branch -->
                        <button type="button"
                                class="btn btn-sm btn-outline-primary action-btn"
                                @onclick="() => HandleEditBranch(module)"
                                @onclick:stopPropagation="true"
                                title="Edit conditional branching">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                            </svg>
                        </button>

                        <!-- Remove -->
                        <button type="button"
                                class="btn btn-sm btn-outline-danger action-btn"
                                @onclick="() => HandleRemoveClick(module)"
                                @onclick:stopPropagation="true"
                                title="Remove module from workflow">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            }
        }
        else
        {
            <!-- Empty State -->
            <div class="module-list-empty">
                <div class="empty-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                        <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"/>
                    </svg>
                </div>
                <h6 class="empty-title">No Modules in Workflow</h6>
                <p class="empty-message">Click "Add Module" to start building your workflow</p>
            </div>
        }
    </div>

    <!-- Footer: Add Module Button -->
    <div class="module-list-footer">
        <button type="button"
                class="btn btn-primary btn-add-module w-100"
                @onclick="ShowAddModuleDialog">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
            </svg>
            Add Module
        </button>
    </div>
</div>

<!-- Add Module Dialog -->
@if (_showAddDialog)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show d-block" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Module to Workflow</h5>
                    <button type="button" class="btn-close" @onclick="CancelAddModule"></button>
                </div>
                <div class="modal-body">
                    @if (AvailableModules != null && AvailableModules.Count > 0)
                    {
                        <div class="available-modules-list">
                            @foreach (var module in AvailableModules)
                            {
                                var isAlreadyAdded = Modules?.Any(m => m.ModuleId == module.Id) ?? false;

                                <div class="available-module-item @(isAlreadyAdded ? "disabled" : "")"
                                     @onclick="() => !isAlreadyAdded ? SelectModuleToAdd(module.Id) : null">
                                    <div class="module-info-compact">
                                        <div class="module-title-compact">@module.TitleEn</div>
                                        <div class="module-id-compact"><code>Module #@module.Id</code></div>
                                    </div>
                                    @if (isAlreadyAdded)
                                    {
                                        <span class="badge bg-secondary">Already Added</span>
                                    }
                                    else
                                    {
                                        <button type="button" class="btn btn-sm btn-primary">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                                            </svg>
                                        </button>
                                    }
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            No available modules found. Create a module first before adding it to a workflow.
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelAddModule">Cancel</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Remove Confirmation Dialog -->
@if (_showRemoveConfirmation && _moduleToRemove != null)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show d-block" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirm Removal</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CancelRemove"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to remove this module from the workflow?</p>
                    <div class="alert alert-warning">
                        <strong>@(_moduleToRemove.TitleEn ?? "Untitled Module")</strong>
                        <br />
                        <small><code>Module #@_moduleToRemove.ModuleId</code></small>
                    </div>
                    <p class="text-muted mb-0">
                        <small>This will not delete the module itself, only remove it from this workflow.</small>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelRemove">Cancel</button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmRemove">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                        </svg>
                        Remove Module
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // ========================================================================
    // PARAMETERS
    // ========================================================================

    /// <summary>
    /// List of modules in the workflow with their details
    /// </summary>
    [Parameter]
    public List<WorkflowModuleInfo>? Modules { get; set; }

    /// <summary>
    /// Currently selected module ID
    /// </summary>
    [Parameter]
    public int? SelectedModuleId { get; set; }

    /// <summary>
    /// List of available modules that can be added to the workflow
    /// </summary>
    [Parameter]
    public List<FormModuleSchema>? AvailableModules { get; set; }

    /// <summary>
    /// Event fired when a module is selected
    /// </summary>
    [Parameter]
    public EventCallback<int> OnModuleSelected { get; set; }

    /// <summary>
    /// Event fired when module should move up
    /// </summary>
    [Parameter]
    public EventCallback<ModuleMoveRequest> OnModuleMoveUp { get; set; }

    /// <summary>
    /// Event fired when module should move down
    /// </summary>
    [Parameter]
    public EventCallback<ModuleMoveRequest> OnModuleMoveDown { get; set; }

    /// <summary>
    /// Event fired when module should be removed
    /// </summary>
    [Parameter]
    public EventCallback<int> OnModuleRemove { get; set; }

    /// <summary>
    /// Event fired when a module is added to the workflow
    /// </summary>
    [Parameter]
    public EventCallback<int> OnModuleAdd { get; set; }

    /// <summary>
    /// Event fired when edit branching is clicked
    /// </summary>
    [Parameter]
    public EventCallback<WorkflowModuleInfo> OnEditBranch { get; set; }

    // ========================================================================
    // STATE
    // ========================================================================

    private bool _showAddDialog = false;
    private bool _showRemoveConfirmation = false;
    private WorkflowModuleInfo? _moduleToRemove = null;

    // ========================================================================
    // HELPER CLASSES
    // ========================================================================

    /// <summary>
    /// Request to move a module within the workflow
    /// </summary>
    public record ModuleMoveRequest(int ModuleId, int CurrentIndex);

    // ========================================================================
    // METHODS
    // ========================================================================

    private int GetModuleCount()
    {
        return Modules?.Count ?? 0;
    }

    private string GetModuleItemClass(bool isSelected)
    {
        return isSelected
            ? "module-list-item module-selected"
            : "module-list-item";
    }

    private string GetOperatorText(string operatorValue)
    {
        return operatorValue switch
        {
            "Equals" => "equals",
            "NotEquals" => "does not equal",
            "Contains" => "contains",
            "GreaterThan" => "is greater than",
            "LessThan" => "is less than",
            "IsEmpty" => "is empty",
            "IsNotEmpty" => "is not empty",
            _ => operatorValue
        };
    }

    // ========================================================================
    // EVENT HANDLERS
    // ========================================================================

    private async Task HandleModuleClick(int moduleId)
    {
        await OnModuleSelected.InvokeAsync(moduleId);
    }

    private async Task HandleMoveUp(int moduleId, int currentIndex)
    {
        await OnModuleMoveUp.InvokeAsync(new ModuleMoveRequest(moduleId, currentIndex));
    }

    private async Task HandleMoveDown(int moduleId, int currentIndex)
    {
        await OnModuleMoveDown.InvokeAsync(new ModuleMoveRequest(moduleId, currentIndex));
    }

    private void HandleRemoveClick(WorkflowModuleInfo module)
    {
        _moduleToRemove = module;
        _showRemoveConfirmation = true;
    }

    private async Task ConfirmRemove()
    {
        if (_moduleToRemove != null)
        {
            await OnModuleRemove.InvokeAsync(_moduleToRemove.ModuleId);
        }
        _showRemoveConfirmation = false;
        _moduleToRemove = null;
    }

    private void CancelRemove()
    {
        _showRemoveConfirmation = false;
        _moduleToRemove = null;
    }

    private void ShowAddModuleDialog()
    {
        _showAddDialog = true;
    }

    private void CancelAddModule()
    {
        _showAddDialog = false;
    }

    private async Task SelectModuleToAdd(int moduleId)
    {
        await OnModuleAdd.InvokeAsync(moduleId);
        _showAddDialog = false;
    }

    private async Task HandleEditBranch(WorkflowModuleInfo module)
    {
        await OnEditBranch.InvokeAsync(module);
    }
}
