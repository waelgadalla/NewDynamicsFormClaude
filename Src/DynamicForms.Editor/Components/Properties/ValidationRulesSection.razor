@using static DynamicForms.Editor.Components.Properties.PropertiesPanel

@*
    ValidationRulesSection - Edit validation rules

    Manages:
    - Required field toggle
    - Built-in validation rules (email, phone, etc.)
    - Custom validation rule IDs
*@

@if (WorkingCopy != null)
{
    <!-- Required Field -->
    <div class="form-check form-switch mb-3">
        <input class="form-check-input"
               type="checkbox"
               id="isRequired"
               @bind="WorkingCopy.IsRequired"
               @bind:after="NotifyChanged" />
        <label class="form-check-label fw-bold" for="isRequired">
            Required Field
        </label>
    </div>

    @if (WorkingCopy.IsRequired)
    {
        <div class="alert alert-warning mb-3">
            <small>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                    <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                </svg>
                This field will be required. Users must provide a value.
            </small>
        </div>
    }

    <!-- Built-in Validation Rules -->
    <div class="mb-3">
        <label class="form-label">Built-in Validation Rules</label>

        <div class="validation-rules-list">
            @foreach (var rule in GetBuiltInRules())
            {
                <div class="form-check mb-2">
                    <input class="form-check-input"
                           type="checkbox"
                           id="@rule.Id"
                           checked="@WorkingCopy.ValidationRules.Contains(rule.Id)"
                           @onchange="() => ToggleValidationRule(rule.Id)" />
                    <label class="form-check-label" for="@rule.Id">
                        <strong>@rule.Name</strong>
                        <small class="text-muted d-block">@rule.Description</small>
                    </label>
                </div>
            }
        </div>
    </div>

    <!-- Custom Validation Rules -->
    <div class="mb-3">
        <label class="form-label">Custom Validation Rules</label>

        @if (WorkingCopy.ValidationRules.Any(r => !GetBuiltInRuleIds().Contains(r)))
        {
            <div class="custom-rules-list mb-2">
                @foreach (var ruleId in WorkingCopy.ValidationRules.Where(r => !GetBuiltInRuleIds().Contains(r)))
                {
                    <div class="custom-rule-item">
                        <code>@ruleId</code>
                        <button type="button"
                                class="btn btn-sm btn-outline-danger"
                                @onclick="() => RemoveValidationRule(ruleId)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
                            </svg>
                        </button>
                    </div>
                }
            </div>
        }

        <div class="input-group">
            <input type="text"
                   class="form-control font-monospace"
                   @bind="_newRuleId"
                   @bind:event="oninput"
                   placeholder="custom_rule_id"
                   @onkeyup="HandleKeyUp" />
            <button type="button"
                    class="btn btn-outline-secondary"
                    @onclick="AddCustomRule"
                    disabled="@string.IsNullOrWhiteSpace(_newRuleId)">
                Add
            </button>
        </div>
        <div class="form-text">Add custom validation rule IDs</div>
    </div>

    <!-- Summary -->
    @if (WorkingCopy.ValidationRules.Any())
    {
        <div class="alert alert-info">
            <small>
                <strong>Active Rules:</strong> @string.Join(", ", WorkingCopy.ValidationRules)
            </small>
        </div>
    }
}

@code {
    // ========================================================================
    // PARAMETERS
    // ========================================================================

    /// <summary>
    /// Working copy of the field being edited
    /// </summary>
    [Parameter]
    public FieldWorkingCopy? WorkingCopy { get; set; }

    /// <summary>
    /// Event fired when any property changes
    /// </summary>
    [Parameter]
    public EventCallback OnPropertyChanged { get; set; }

    // ========================================================================
    // STATE
    // ========================================================================

    private string _newRuleId = string.Empty;

    private record BuiltInRule(string Id, string Name, string Description);

    // ========================================================================
    // METHODS
    // ========================================================================

    private List<BuiltInRule> GetBuiltInRules()
    {
        return new List<BuiltInRule>
        {
            new("email", "Email", "Must be a valid email address"),
            new("phone", "Phone Number", "Must be a valid phone number"),
            new("url", "URL", "Must be a valid web address"),
            new("postal_code", "Postal Code", "Must be a valid postal/zip code"),
            new("numeric", "Numeric", "Must contain only numbers"),
            new("alpha", "Alphabetic", "Must contain only letters"),
            new("alphanumeric", "Alphanumeric", "Must contain only letters and numbers"),
            new("date", "Date", "Must be a valid date"),
            new("past_date", "Past Date", "Must be a date in the past"),
            new("future_date", "Future Date", "Must be a date in the future"),
        };
    }

    private List<string> GetBuiltInRuleIds()
    {
        return GetBuiltInRules().Select(r => r.Id).ToList();
    }

    private void ToggleValidationRule(string ruleId)
    {
        if (WorkingCopy == null) return;

        if (WorkingCopy.ValidationRules.Contains(ruleId))
        {
            WorkingCopy.ValidationRules.Remove(ruleId);
        }
        else
        {
            WorkingCopy.ValidationRules.Add(ruleId);
        }

        NotifyChanged();
    }

    private void RemoveValidationRule(string ruleId)
    {
        if (WorkingCopy == null) return;

        WorkingCopy.ValidationRules.Remove(ruleId);
        NotifyChanged();
    }

    private void AddCustomRule()
    {
        if (WorkingCopy == null || string.IsNullOrWhiteSpace(_newRuleId)) return;

        var ruleId = _newRuleId.Trim().ToLower();

        if (!WorkingCopy.ValidationRules.Contains(ruleId))
        {
            WorkingCopy.ValidationRules.Add(ruleId);
            _newRuleId = string.Empty;
            NotifyChanged();
        }
    }

    private void HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            AddCustomRule();
        }
    }

    private async Task NotifyChanged()
    {
        await OnPropertyChanged.InvokeAsync();
    }
}
