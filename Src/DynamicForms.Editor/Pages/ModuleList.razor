@page "/modules"
@using DynamicForms.Editor.Data.Entities
@using DynamicForms.Editor.Data.Repositories
@inject IEditorModuleRepository ModuleRepository
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageTitle>Modules - Dynamic Forms Editor</PageTitle>

<div class="module-list-container">
    <!-- Header Section -->
    <div class="module-list-header">
        <div class="header-left">
            <h2>
                <i class="bi bi-folder2-open"></i>
                Form Modules
            </h2>
            <p class="text-muted">Manage and organize your form modules</p>
        </div>
        <div class="header-right">
            <button class="btn btn-primary" @onclick="CreateNewModule">
                <i class="bi bi-plus-circle-fill"></i>
                <span class="ms-2">Create New Module</span>
            </button>
        </div>
    </div>

    <!-- Search and Filter Bar -->
    <div class="filter-bar">
        <div class="search-box">
            <i class="bi bi-search"></i>
            <input type="text"
                   class="form-control"
                   placeholder="Search by title..."
                   @bind="searchTerm"
                   @bind:event="oninput"
                   @onkeyup="OnSearchChanged" />
            @if (!string.IsNullOrEmpty(searchTerm))
            {
                <button class="btn-clear" @onclick="ClearSearch">
                    <i class="bi bi-x-circle-fill"></i>
                </button>
            }
        </div>

        <div class="filter-controls">
            <select class="form-select" @bind="statusFilter" @bind:after="ApplyFilters">
                <option value="">All Status</option>
                <option value="Draft">Draft</option>
                <option value="Published">Published</option>
                <option value="Archived">Archived</option>
            </select>

            <select class="form-select" @bind="sortColumn" @bind:after="ApplySorting">
                <option value="ModifiedAt">Last Modified</option>
                <option value="Title">Title</option>
                <option value="ModuleId">Module ID</option>
                <option value="Status">Status</option>
                <option value="Version">Version</option>
            </select>

            <button class="btn btn-outline-secondary" @onclick="ToggleSortDirection">
                <i class="bi @(sortAscending ? "bi-sort-up" : "bi-sort-down")"></i>
            </button>
        </div>
    </div>

    <!-- Stats Bar -->
    @if (!isLoading && allModules.Any())
    {
        <div class="stats-bar">
            <span class="stat-item">
                <strong>@filteredModules.Count</strong> of <strong>@allModules.Count</strong> modules
            </span>
            <span class="stat-divider">|</span>
            <span class="stat-item">
                <i class="bi bi-circle-fill text-warning"></i>
                <strong>@draftCount</strong> Drafts
            </span>
            <span class="stat-divider">|</span>
            <span class="stat-item">
                <i class="bi bi-circle-fill text-success"></i>
                <strong>@publishedCount</strong> Published
            </span>
            <span class="stat-divider">|</span>
            <span class="stat-item">
                <i class="bi bi-circle-fill text-secondary"></i>
                <strong>@archivedCount</strong> Archived
            </span>
        </div>
    }

    <!-- Loading State -->
    @if (isLoading)
    {
        <div class="loading-container">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading modules...</p>
        </div>
    }
    <!-- Empty State -->
    else if (!allModules.Any())
    {
        <div class="empty-state">
            <i class="bi bi-folder2-open"></i>
            <h4>No modules found</h4>
            <p>Get started by creating your first form module</p>
            <button class="btn btn-primary" @onclick="CreateNewModule">
                <i class="bi bi-plus-circle-fill"></i>
                <span class="ms-2">Create New Module</span>
            </button>
        </div>
    }
    <!-- No Results State -->
    else if (!filteredModules.Any())
    {
        <div class="empty-state">
            <i class="bi bi-search"></i>
            <h4>No modules match your search</h4>
            <p>Try adjusting your search criteria or filters</p>
            <button class="btn btn-outline-secondary" @onclick="ClearFilters">
                Clear Filters
            </button>
        </div>
    }
    <!-- Module Table -->
    else
    {
        <div class="table-responsive">
            <table class="table table-hover module-table">
                <thead>
                    <tr>
                        <th @onclick='() => SortByColumn("ModuleId")' class="sortable">
                            Module ID
                            @if (sortColumn == "ModuleId")
                            {
                                <i class="bi @(sortAscending ? "bi-caret-up-fill" : "bi-caret-down-fill")"></i>
                            }
                        </th>
                        <th @onclick='() => SortByColumn("Title")' class="sortable">
                            Title
                            @if (sortColumn == "Title")
                            {
                                <i class="bi @(sortAscending ? "bi-caret-up-fill" : "bi-caret-down-fill")"></i>
                            }
                        </th>
                        <th @onclick='() => SortByColumn("Status")' class="sortable">
                            Status
                            @if (sortColumn == "Status")
                            {
                                <i class="bi @(sortAscending ? "bi-caret-up-fill" : "bi-caret-down-fill")"></i>
                            }
                        </th>
                        <th @onclick='() => SortByColumn("Version")' class="sortable">
                            Version
                            @if (sortColumn == "Version")
                            {
                                <i class="bi @(sortAscending ? "bi-caret-up-fill" : "bi-caret-down-fill")"></i>
                            }
                        </th>
                        <th @onclick='() => SortByColumn("ModifiedAt")' class="sortable">
                            Last Modified
                            @if (sortColumn == "ModifiedAt")
                            {
                                <i class="bi @(sortAscending ? "bi-caret-up-fill" : "bi-caret-down-fill")"></i>
                            }
                        </th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var module in paginatedModules)
                    {
                        <ModuleListItem Module="module"
                                        OnEdit="HandleEdit"
                                        OnDelete="HandleDelete"
                                        OnClone="HandleClone" />
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        @if (totalPages > 1)
        {
            <div class="pagination-container">
                <div class="pagination-info">
                    Showing @((currentPage - 1) * pageSize + 1) to @Math.Min(currentPage * pageSize, filteredModules.Count) of @filteredModules.Count modules
                </div>
                <nav>
                    <ul class="pagination">
                        <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="() => GoToPage(1)" disabled="@(currentPage == 1)">
                                <i class="bi bi-chevron-double-left"></i>
                            </button>
                        </li>
                        <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="() => GoToPage(currentPage - 1)" disabled="@(currentPage == 1)">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                        </li>

                        @foreach (var pageNum in GetVisiblePages())
                        {
                            <li class="page-item @(pageNum == currentPage ? "active" : "")">
                                <button class="page-link" @onclick="() => GoToPage(pageNum)">@pageNum</button>
                            </li>
                        }

                        <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                            <button class="page-link" @onclick="() => GoToPage(currentPage + 1)" disabled="@(currentPage == totalPages)">
                                <i class="bi bi-chevron-right"></i>
                            </button>
                        </li>
                        <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                            <button class="page-link" @onclick="() => GoToPage(totalPages)" disabled="@(currentPage == totalPages)">
                                <i class="bi bi-chevron-double-right"></i>
                            </button>
                        </li>
                    </ul>
                </nav>
            </div>
        }
    }
</div>

@code {
    // Data
    private List<EditorFormModule> allModules = new();
    private List<EditorFormModule> filteredModules = new();
    private List<EditorFormModule> paginatedModules = new();

    // State
    private bool isLoading = true;
    private string searchTerm = string.Empty;
    private string statusFilter = string.Empty;
    private string sortColumn = "ModifiedAt";
    private bool sortAscending = false;

    // Pagination
    private int currentPage = 1;
    private int pageSize = 50;
    private int totalPages => (int)Math.Ceiling((double)filteredModules.Count / pageSize);

    // Stats
    private int draftCount => allModules.Count(m => m.Status == "Draft");
    private int publishedCount => allModules.Count(m => m.Status == "Published");
    private int archivedCount => allModules.Count(m => m.Status == "Archived");

    protected override async Task OnInitializedAsync()
    {
        await LoadModulesAsync();
    }

    private async Task LoadModulesAsync()
    {
        isLoading = true;
        try
        {
            allModules = await ModuleRepository.GetAllAsync();
            ApplyFilters();
        }
        catch (Exception ex)
        {
            // TODO: Add error handling/notification
            Console.WriteLine($"Error loading modules: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OnSearchChanged()
    {
        currentPage = 1;
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        filteredModules = allModules;

        // Apply search filter
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var search = searchTerm.Trim().ToLowerInvariant();
            filteredModules = filteredModules.Where(m =>
                m.Title.ToLowerInvariant().Contains(search) ||
                (m.TitleFr?.ToLowerInvariant().Contains(search) ?? false) ||
                m.ModuleId.ToString().Contains(search)
            ).ToList();
        }

        // Apply status filter
        if (!string.IsNullOrWhiteSpace(statusFilter))
        {
            filteredModules = filteredModules.Where(m => m.Status == statusFilter).ToList();
        }

        ApplySorting();
    }

    private void ApplySorting()
    {
        filteredModules = sortColumn switch
        {
            "ModuleId" => sortAscending
                ? filteredModules.OrderBy(m => m.ModuleId).ToList()
                : filteredModules.OrderByDescending(m => m.ModuleId).ToList(),
            "Title" => sortAscending
                ? filteredModules.OrderBy(m => m.Title).ToList()
                : filteredModules.OrderByDescending(m => m.Title).ToList(),
            "Status" => sortAscending
                ? filteredModules.OrderBy(m => m.Status).ToList()
                : filteredModules.OrderByDescending(m => m.Status).ToList(),
            "Version" => sortAscending
                ? filteredModules.OrderBy(m => m.Version).ToList()
                : filteredModules.OrderByDescending(m => m.Version).ToList(),
            "ModifiedAt" => sortAscending
                ? filteredModules.OrderBy(m => m.ModifiedAt).ToList()
                : filteredModules.OrderByDescending(m => m.ModifiedAt).ToList(),
            _ => filteredModules.OrderByDescending(m => m.ModifiedAt).ToList()
        };

        UpdatePagination();
    }

    private void SortByColumn(string column)
    {
        if (sortColumn == column)
        {
            sortAscending = !sortAscending;
        }
        else
        {
            sortColumn = column;
            sortAscending = true;
        }
        ApplySorting();
    }

    private void ToggleSortDirection()
    {
        sortAscending = !sortAscending;
        ApplySorting();
    }

    private void UpdatePagination()
    {
        if (currentPage > totalPages && totalPages > 0)
        {
            currentPage = totalPages;
        }

        var skip = (currentPage - 1) * pageSize;
        paginatedModules = filteredModules.Skip(skip).Take(pageSize).ToList();
    }

    private void GoToPage(int page)
    {
        if (page >= 1 && page <= totalPages)
        {
            currentPage = page;
            UpdatePagination();
        }
    }

    private List<int> GetVisiblePages()
    {
        var pages = new List<int>();
        var start = Math.Max(1, currentPage - 2);
        var end = Math.Min(totalPages, currentPage + 2);

        for (int i = start; i <= end; i++)
        {
            pages.Add(i);
        }

        return pages;
    }

    private void ClearSearch()
    {
        searchTerm = string.Empty;
        currentPage = 1;
        ApplyFilters();
    }

    private void ClearFilters()
    {
        searchTerm = string.Empty;
        statusFilter = string.Empty;
        currentPage = 1;
        ApplyFilters();
    }

    private void CreateNewModule()
    {
        NavigationManager.NavigateTo("/editor/module");
    }

    private void HandleEdit(int moduleId)
    {
        NavigationManager.NavigateTo($"/editor/module/{moduleId}");
    }

    private async Task HandleDelete(int id)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>(
            "confirm",
            "Are you sure you want to delete this module? This action cannot be undone."
        );

        if (confirmed)
        {
            try
            {
                var success = await ModuleRepository.DeleteAsync(id);
                if (success)
                {
                    await LoadModulesAsync();
                }
            }
            catch (Exception ex)
            {
                // TODO: Add error notification
                Console.WriteLine($"Error deleting module: {ex.Message}");
            }
        }
    }

    private async Task HandleClone(int id)
    {
        try
        {
            var originalModule = await ModuleRepository.GetByIdAsync(id);
            if (originalModule != null)
            {
                var nextModuleId = await ModuleRepository.GetNextModuleIdAsync();
                var clonedModule = new EditorFormModule
                {
                    ModuleId = nextModuleId,
                    Title = $"{originalModule.Title} (Copy)",
                    TitleFr = originalModule.TitleFr != null ? $"{originalModule.TitleFr} (Copie)" : null,
                    Description = originalModule.Description,
                    DescriptionFr = originalModule.DescriptionFr,
                    SchemaJson = originalModule.SchemaJson,
                    Version = 1,
                    Status = "Draft",
                    CreatedAt = DateTime.UtcNow,
                    ModifiedAt = DateTime.UtcNow,
                    ModifiedBy = "System"
                };

                await ModuleRepository.CreateAsync(clonedModule);
                await LoadModulesAsync();
            }
        }
        catch (Exception ex)
        {
            // TODO: Add error notification
            Console.WriteLine($"Error cloning module: {ex.Message}");
        }
    }
}
